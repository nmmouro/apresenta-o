<script>
const SHEET_ID = "https://docs.google.com/spreadsheets/d/1t3AHzKwC3ob6DxxeOEyTS8mOSvqpRH4Zqb4qxqE0bOM/edit?gid=0#gid=0";
const TAB_NAME = "RUV-RMV";

function updateClock(){
  const n = new Date();
  document.getElementById("clock").innerText =
    n.toLocaleDateString("pt-BR")+" — "+
    n.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});
}
setInterval(updateClock,1000);
updateClock();

const parseGviz = t =>
  JSON.parse(t.substring(t.indexOf("{"), t.lastIndexOf("}") + 1));

const formatCell = c =>
  c == null ? "" : (typeof c === "object" ? (c.f ?? c.v ?? "") : String(c));

async function fetchSheet(){
  const url =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq`+
    `?sheet=${encodeURIComponent(TAB_NAME)}&tqx=out:json&nocache=${Date.now()}`;
  const r = await fetch(url,{cache:"no-store"});
  return parseGviz(await r.text());
}

let allData=[];

function getMonthIndex(m){
  if(!m) return -1;
  const clean = m.toString().trim().toLowerCase();
  const months = ["janeiro","fevereiro","março","abril","maio","junho",
                  "julho","agosto","setembro","outubro","novembro","dezembro"];
  return months.indexOf(clean);
}

function sortData(){
  allData.sort((a,b)=>{
    if(a.ano!=b.ano) return b.ano - a.ano;
    return a.mesIndex - b.mesIndex;
  });
}

let selectedYear = "all";

function renderFilter(){
  const years=[...new Set(allData.map(d=>d.ano))];
  const sel=document.getElementById("yearFilter");

  selectedYear = sel.value || "all";

  sel.innerHTML = `<option value="all">Todos</option>`;
  years.forEach(y=>{
    sel.innerHTML += `<option value="${y}">${y}</option>`;
  });

  sel.value = selectedYear;
  sel.onchange = () => renderCards();
}

function renderCards(){
  const year=document.getElementById("yearFilter").value;
  const box=document.getElementById("cards");
  box.innerHTML="";

  allData
    .filter(d=>year=="all"||d.ano==year)
    .forEach(d=>{
      box.innerHTML+=`
        <div class="month-card">
          <div class="month">${d.mes}</div>
          <div class="year">${d.ano}</div>
          <div style="margin-top:8px;display:grid;gap:4px;">
            <button onclick="openReport('${d.v1}')">V1</button>
            <button onclick="openReport('${d.v2}')">V2</button>
            <button onclick="openReport('${d.v3}')">V3</button>
            <button onclick="openReport('${d.v4}')">V4</button>
            <button onclick="openReport('${d.resumo}')">Resumo</button>
            <button onclick="openAll('${d.v1}','${d.v2}','${d.v3}','${d.v4}','${d.resumo}')">PDF Geral</button>
          </div>
        </div>
      `;
    });
}

function openReport(link){
  document.getElementById("viewer").src = link;
}

function openAll(v1,v2,v3,v4,resumo){
  const links=[v1,v2,v3,v4,resumo];
  const html = links.map(l=>`<iframe src="${l}" style="width:100%;height:100vh;"></iframe>`).join("");
  const w = window.open();
  w.document.write(html);
  w.document.close();
}

async function load(){
  const g=await fetchSheet();
  const rows = (g.table.rows || []).filter(r=>{
    const c = r.c || [];
    return c[0] && !isNaN(c[0].v);
  });

  allData=rows.map(r=>{
    const c=r.c||[];
    return {
      ano:formatCell(c[0]),
      mes:formatCell(c[1]),
      mesIndex:getMonthIndex(formatCell(c[1])),
      v1:formatCell(c[2]),
      v2:formatCell(c[3]),
      v3:formatCell(c[4]),
      v4:formatCell(c[5]),
      resumo:formatCell(c[6])
    };
  });

  sortData();
  renderFilter();
  renderCards();
}

load();
</script>
