<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel - Relat√≥rios de Frota</title>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<style>
:root{
  --bg:#071029;
  --card:#071029;
  --muted:#f7f9fa;
  --accent:#f7f9fa;
}
html,body{
  height:100%;
  margin:0;
  background:var(--bg);
  color:#fff;
  font-family:Inter,Arial;
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 34px;
  background:#020617;
  border-radius:10px;
  border:1px solid #ffffff;
}
header .title{font-size:26px;font-weight:700;color:var(--accent);}
header .clock{font-size:22px;font-weight:700;color:var(--muted);}
main{
  padding:12px;
  height:calc(100vh - 92px);
  display:grid;
  grid-template-columns: 1fr 2fr;
  gap:10px;
}
.card{
  background:var(--card);
  border-radius:10px;
  padding:12px;
  overflow:auto;
}
.card h2{
  margin:0 0 8px;
  color:var(--accent);
  font-size:22px;
  text-align:center;
}
.filter{
  text-align:center;
  margin-bottom:10px;
}
select{
  padding:6px 12px;
  font-size:16px;
  border-radius:6px;
}
.cards{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
  gap:10px;
}
.month-card{
  background:#2c4078;
  border-radius:10px;
  padding:10px;
  text-align:center;
  border:1px solid white;
}
.month-card .month{font-size:16px;font-weight:700;}
.month-card .year{font-size:13px;opacity:.8;}
.month-card button{
  width:100%;
  margin-top:4px;
  padding:6px;
  border-radius:6px;
  border:none;
  cursor:pointer;
  font-weight:700;
}
iframe{
  width:100%;
  height:100%;
  border:none;
  border-radius:10px;
  background:white;
}
.small{
  text-align:center;
  font-size:12px;
  color:var(--muted);
}
</style>
</head>

<body>

<header>
  <div class="title">RELAT√ìRIOS DE UTILIZA√á√ÉO DE VE√çCULOS</div>
  <div class="clock" id="clock"></div>
</header>

<main>
  <section class="card">
    <h2>RUV-RMV</h2>
    <div class="filter">
      Ano:
      <select id="yearFilter"></select>
    </div>
    <div id="cards" class="cards"></div>
  </section>

  <section class="card">
    <h2>Relat√≥rio</h2>
    <iframe id="viewer"></iframe>
  </section>
</main>

<div class="small">Atualiza√ß√£o autom√°tica ‚Ä¢ Google Sheets</div>

<script>
const SHEET_ID = "1t3AHzKwC3ob6DxxeOEyTS8mOSvqpRH4Zqb4qxqE0bOM";
const TAB_NAME = "RUV-RMV";

function updateClock(){
  const n = new Date();
  document.getElementById("clock").innerText =
    n.toLocaleDateString("pt-BR")+" ‚Äî "+
    n.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});
}
setInterval(updateClock,1000);
updateClock();

const parseGviz = t =>
  JSON.parse(t.substring(t.indexOf("{"), t.lastIndexOf("}") + 1));

const formatCell = c =>
  c == null ? "" : (typeof c === "object" ? (c.f ?? c.v ?? "") : String(c));

async function fetchSheet(){
  const url =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq`+
    `?sheet=${encodeURIComponent(TAB_NAME)}&tqx=out:json&nocache=${Date.now()}`;
  const r = await fetch(url,{cache:"no-store"});
  return parseGviz(await r.text());
}

let allData=[];

function getMonthIndex(m){
  if(!m) return -1;
  const clean = m.toString().trim().toLowerCase();
  const months = ["janeiro","fevereiro","mar√ßo","abril","maio","junho",
                  "julho","agosto","setembro","outubro","novembro","dezembro"];
  return months.indexOf(clean);
}

function sortData(){
  allData.sort((a,b)=>{
    if(a.ano!=b.ano) return b.ano - a.ano;
    return a.mesIndex - b.mesIndex;
  });
}

function renderFilter(){
  const years=[...new Set(allData.map(d=>d.ano))];
  const sel=document.getElementById("yearFilter");
  sel.innerHTML = `<option value="all">Todos</option>`;
  years.forEach(y=>{
    sel.innerHTML += `<option value="${y}">${y}</option>`;
  });
  sel.onchange = () => renderCards();
}

function renderCards(){
  const year=document.getElementById("yearFilter").value;
  const box=document.getElementById("cards");
  box.innerHTML="";

  allData
    .filter(d=>year=="all"||d.ano==year)
    .forEach(d=>{
      box.innerHTML+=`
        <div class="month-card">
          <div class="month">${d.mes}</div>
          <div class="year">${d.ano}</div>
          <button onclick="openReport('${d.v1}')">V1</button>
          <button onclick="openReport('${d.v2}')">V2</button>
          <button onclick="openReport('${d.v3}')">V3</button>
          <button onclick="openReport('${d.v4}')">V4</button>
          <button onclick="openReport('${d.resumo}')">Resumo</button>
          <button onclick="openAll('${d.v1}','${d.v2}','${d.v3}','${d.v4}','${d.resumo}')">PDF Geral</button>
        </div>
      `;
    });
}

function openReport(link){
  document.getElementById("viewer").src = link;
}

function openAll(v1,v2,v3,v4,resumo){
  const links=[v1,v2,v3,v4,resumo];

  const pdfLinks = links.map(l=>{
    const id = l.match(/\/d\/([^\/]+)/)[1];
    const gid = l.match(/gid=([0-9]+)/)[1];
    return `https://docs.google.com/spreadsheets/d/${id}/export?format=pdf` +
           `&gid=${gid}` +
           `&portrait=false` +   // üëà PAISAGEM
           `&size=A4` +
           `&fitw=true` +
           `&sheetnames=false&printtitle=false&pagenumbers=false` +
           `&gridlines=false&fzr=false`;
  });

  const html = `
  <html>
  <head>
    <style>
      body{margin:0;}
      embed{width:100%;height:100vh;page-break-after:always;}
    </style>
  </head>
  <body>
    ${pdfLinks.map(p=>`<embed src="${p}" type="application/pdf">`).join("")}
  </body>
  </html>
  `;

  const w = window.open();
  w.document.write(html);
  w.document.close();
}

async function load(){
  const g=await fetchSheet();
  const rows = (g.table.rows || []).filter(r=>{
    const c = r.c || [];
    return c[0] && !isNaN(c[0].v);
  });

  allData=rows.map(r=>{
    const c=r.c||[];
    return {
      ano:formatCell(c[0]),
      mes:formatCell(c[1]),
      mesIndex:getMonthIndex(formatCell(c[1])),
      v1:formatCell(c[2]),
      v2:formatCell(c[3]),
      v3:formatCell(c[4]),
      v4:formatCell(c[5]),
      resumo:formatCell(c[6])
    };
  });

  sortData();
  renderFilter();
  renderCards();
}

load();
</script>

</body>
</html>
